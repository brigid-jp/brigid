<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>brigid</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/3.0.1/github-markdown.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<style>
.markdown-body {
  box-sizing: border-box;
  min-width: 200px;
  max-width: 980px;
  margin: 0 auto;
  padding: 45px;
}
@media (max-width: 767px) {
  .markdown-body {
    padding: 15px;
  }
}
.note {
  color: #999;
}
</style>
</head>
<body>
<div class="markdown-body">

<h1>brigid</h1>

<h2 id="crypto-impl">crypto実装</h2>

<table>
  <tr>
    <th>実装名</th>
    <th>バックエンド</th>
    <th>環境</th>
  </tr>

  <tr>
    <td>crypto_openssl</td>
    <td>OpenSSL EVP</td>
    <td>UNIX or UNIX like systems</td>
  </tr>

  <tr>
    <td>crypto_apple</td>
    <td>CommonCrypto</td>
    <td>macOS and iOS</td>
  </tr>

  <tr>
    <td>crypto_windows</td>
    <td>CNG (Cryptography API: Next Generation)</td>
    <td>Windows</td>
  </tr>

  <tr>
    <td>crypto_java</td>
    <td>JCE (Java Cryptographic Extension)</td>
    <td>Android</td>
  </tr>
</table>

<h3>AES-256の指定</h3>

<table>
  <tr>
    <th>Backend</th>
    <th>Cipher</th>
    <th>Mode</th>
    <th>Padding</th>
  </tr>
  <tr>
    <td>OpenSSL EVP</td>
    <td colspan="2"><code>EVP_aes_256_cbc()</code></td>
    <td>padding is enabled (the default)</td>
  </tr>
  <tr>
    <td>CommonCrypto</td>
    <td><code>kCCAlgorithmAES</code></td>
    <td><code>kCCModeCBC</code></td>
    <td><code>kCCOptionPKCS57adding</code></td>
  </tr>
  <tr>
    <td>CNG</td>
    <td><code>BCRYPT_AES_ALGORITHM</code></td>
    <td><code>BCRYPT_CHAIN_MODE_CBC</code></td>
    <td><code>BCRYPT_BLOCK_PADDING</code></td>
  </tr>
  <tr>
    <td>JCE</td>
    <td colspan="3"><code>AES/CBC/PKCS5Padding</code></td>
  </tr>
</table>

<h2 id="http-impl">http実装</h2>

<table>
  <tr>
    <th>実装名</th>
    <th>バックエンド</th>
    <th>非同期</th>
    <th>環境</th>
  </tr>

  <tr>
    <td>http_curl</td>
    <td>curl</td>
    <td>curl_multi</td>
    <td>UNIX or UNIX like systems</td>
  </tr>

  <tr>
    <td>http_apple</td>
    <td>NSURLSession</td>
    <td>yes</td>
    <td>macOS and iOS</td>
  </tr>

  <tr>
    <td>http_windows</td>
    <td>WinHTTP</td>
    <td>WINHTTP_FLAG_ASYNC</td>
    <td>Windows</td>
  </tr>

  <tr>
    <td>http_java</td>
    <td>java.net.HttpUrlConnection</td>
    <td>no</td>
    <td>Android</td>
  </tr>
</table>

<h3>java.net.HttpUrlConnection</h3>

<ul>
  <li>PROPFINDなどのWebDAV拡張メソッドが利用できないようです。</li>
  <li>AndroidのHttpUrlConnectionはBasic認証しか使えないようです。</li>
</ul>

<ul>
  <li><a href="https://docs.microsoft.com/en-us/windows/win32/wininet/wininet-vs-winhttp">WinINet vs. WinHTTP</a></li>
</ul>

<h2 id="luarocks-for-windows">L&ouml;VE互換のWindows開発環境</h2>

<p>
<a href="https://love2d.org/">L&Ouml;VE</a>のWindowsバイナリはVisual Studio 2013でビルドされています。
L&Ouml;VEが配布するDLL（lua51.dllとmsvcp120.dllとmsvcr120.dll）を共用したいので、これに合わせた開発環境を用意します。
</p>

<ul>
  <li>Microsoft
    <ul>
      <li>Microsoft Visual Studio Community 2013 with Update 5</li>
    </ul>
  </li>
  <li><a href="http://luabinaries.sourceforge.net/download.html">LuaBinaries</a>
    <ul>
      <li><a href="https://sourceforge.net/projects/luabinaries/files/5.1.5/Tools%20Executables/lua-5.1.5_Win64_bin.zip/download">lua-5.1.5_Win64_bin.zip</a></li>
      <li><a href="https://sourceforge.net/projects/luabinaries/files/5.1.5/Windows%20Libraries/Dynamic/lua-5.1.5_Win64_dll12_lib.zip/download">lua-5.1.5_Win64_dll12_lib.zip</a></li>
    </ul>
  </li>
  <li><a href="https://luarocks.github.io/luarocks/releases/">LuaRocks</a>
    <ul>
      <li><a href="https://luarocks.github.io/luarocks/releases/luarocks-3.2.1-windows-32.zip">luarocks-3.2.1-windows-32.zip</a></li>
    </ul>
  </li>
</ul>

<p>
LuaBinariesの配布物のライブラリ依存関係は下記のようになっています。
</p>

<pre>
lua5.1.exe
  ↓
lua5.1.dll ← lua5.1.lib
  ↑
lua51.dll ← lua51.lib
</pre>

<p>
L&Ouml;VEのライブラリ依存関係は下記のようになっています。
</p>

<pre>
love.exe
  ↓
lua51.dll
</pre>

<p>
つまり、lua51.dllに依存するモジュールを作成すればL&Ouml;VEでも使うことができます。
LuaRocksの探索は癖が強いので、以下のような構成にしました（<a href="lua-x64.zip">lua-x64.zip</a>にまとめてあります）。
</p>

<pre>
c:/opt/lua-x64/bin/lua5.1.dll
c:/opt/lua-x64/bin/lua5.1.exe
c:/opt/lua-x64/bin/lua51.dll
c:/opt/lua-x64/bin/luarocks-admin.exe
c:/opt/lua-x64/bin/luarocks.exe

c:/opt/lua-x64/include/lauxlib.h
c:/opt/lua-x64/include/lua.h
c:/opt/lua-x64/include/lua.hpp
c:/opt/lua-x64/include/luaconf.h
c:/opt/lua-x64/include/lualib.h

-- lua-5.1.5_Win64_dll12_lib.zipのlua51.libをlua5.1.libに名前変更
c:/opt/lua-x64/lib/lua5.1.lib
</pre>

<p>
これでluarocksが利用できます。
私が確認したWindows 10環境ではAdministratorユーザでないとうまく動きませんでした。
</p>

<pre>
set PATH=c:\opt\lua-x64\bin;%PATH%
luarocks --lua-version 5.1 config
luarocks --lua-version 5.1 make
</pre>

</div>
</body>
</html>
